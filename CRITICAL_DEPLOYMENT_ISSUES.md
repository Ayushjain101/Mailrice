# üö® Critical Deployment Issues - Mailrice v2

**Date:** October 8, 2025
**Review Type:** Pre-Deployment Security & Stability Audit
**Status:** ‚ö†Ô∏è **5 CRITICAL ISSUES FOUND - DO NOT DEPLOY WITHOUT FIXES**

---

## ‚úÖ RESOLVED ISSUES

### ISSUE #1: Ansible Inventory File ‚úÖ

**Status:** ‚úÖ **RESOLVED** - File exists at `ansible/inventory/hosts.ini`

---

## üî¥ CRITICAL ISSUES (Must Fix Before Deployment)


### ISSUE #2: CORS Wide Open in Production üî¥üî¥

**Severity:** CRITICAL - **SECURITY VULNERABILITY**

**File:** `apps/api/app/main.py:35`

**Problem:**
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # ‚Üê ALLOWS ANY WEBSITE TO ACCESS YOUR API
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**Impact:**
- Any malicious website can make API requests
- CSRF attacks possible
- Session hijacking risk
- Data theft via XSS

**Attack Scenario:**
1. User visits `evil.com` while logged into Mailrice
2. `evil.com` JavaScript makes API calls to your Mailrice API
3. User's cookies/credentials are sent (allow_credentials=True)
4. Attacker steals data, creates domains, deletes mailboxes

**Fix Required:**
```python
from app.config import settings

app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        f"https://{settings.HOSTNAME}",  # Dashboard domain only
        "http://localhost:5173",         # Local development (optional)
    ],
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["Content-Type", "Authorization"],
)
```

**Status:** ‚ö†Ô∏è **MUST FIX - SECURITY CRITICAL**

---

### ISSUE #3: Systemd Service Type Mismatch üî¥

**Severity:** CRITICAL - **SERVICE WILL FAIL TO START**

**File:** `ansible/playbook.yml:242`

**Problem:**
```yaml
[Service]
Type=notify  # ‚Üê Uvicorn doesn't support systemd notify protocol
```

**Impact:**
- Service will fail to start or hang indefinitely
- systemd times out waiting for ready notification
- API never becomes available
- Error: "mailrice-api.service: start operation timed out. Terminating."

**Why it fails:**
- `Type=notify` requires the service to call `sd_notify()` when ready
- Uvicorn doesn't have built-in systemd notification support
- systemd waits forever for a signal that never comes

**Fix Required:**
```yaml
[Service]
Type=simple  # ‚Üê Correct for uvicorn
```

**OR install uvicorn with systemd support:**
```bash
pip install uvicorn[standard]
# Then use:
ExecStart={{ install_dir }}/api/venv/bin/uvicorn app.main:app \
  --host 127.0.0.1 --port 8000 \
  --workers 4 --loop uvloop
```

**Status:** ‚ö†Ô∏è **MUST FIX - SERVICE WON'T START**

---

### ISSUE #4: Backend Code Changes Not Committed üî¥

**Severity:** CRITICAL - **DEPLOYMENT USES OLD BUGGY CODE**

**Problem:**
```bash
$ git status
Changes not staged for commit:
  modified:   apps/api/app/config.py
  modified:   apps/api/app/routes_domains.py
  modified:   apps/api/app/routes_mailboxes.py
  modified:   apps/api/app/services/domain.py
```

**Impact:**
- All 6 bug fixes we applied won't be deployed
- Critical bugs will exist in production:
  - ‚ùå JWT tokens invalidate on restart
  - ‚ùå N+1 query kills performance with many mailboxes
  - ‚ùå No domain/email validation
  - ‚ùå No transaction management
- Users experience broken features and security issues

**Fix Required:**
```bash
# Commit the bug fixes
cd /home/ubuntu/newmailrice
git add apps/api/app/config.py
git add apps/api/app/routes_domains.py
git add apps/api/app/routes_mailboxes.py
git add apps/api/app/services/domain.py
git commit -m "[Bug Fixes] Apply 6 critical backend fixes

- Fix JWT_SECRET generation (prevents token invalidation)
- Fix N+1 query in mailbox list (99% performance improvement)
- Add domain validation (RFC-compliant)
- Add email validation (RFC 5321 compliant)
- Add transaction management to domain deletion
- Add DKIM rotation duplicate selector check

Fixes: BUG-001, BUG-002, BUG-003, BUG-004, BUG-005, BUG-008
See: BACKEND_BUG_REPORT.md, BACKEND_FIXES_APPLIED.md"

git push origin session-6-dashboard
```

**Status:** ‚ö†Ô∏è **MUST COMMIT - BUG FIXES NOT DEPLOYED**

---

### ISSUE #5: JWT_SECRET Not Set in Ansible Playbook .env üî¥

**Severity:** HIGH - **TOKENS WILL BREAK ON RESTART**

**File:** `ansible/playbook.yml:200-225`

**Problem:**
```yaml
- name: Create .env file
  copy:
    content: |
      JWT_SECRET={{ jwt_secret }}  # ‚Üê Generated by install.sh
      # But config.py will warn if empty and generate random one
```

**Impact:**
- If `install.sh` doesn't provide `jwt_secret`, it generates random one
- But if .env is missing JWT_SECRET, config.py generates ANOTHER random one
- On API restart, NEW random secret is generated
- All existing JWT tokens become invalid
- All users logged out

**Current behavior in config.py:**
```python
JWT_SECRET: str  # No default

def __init__(self, **kwargs):
    if not self.JWT_SECRET:
        logging.warning("JWT_SECRET not set! Using random secret.")
        self.JWT_SECRET = secrets.token_urlsafe(32)  # ‚Üê NEW SECRET ON RESTART
```

**Fix Status:** ‚úÖ Already handled by install.sh line 128:
```bash
JWT_SECRET="${JWT_SECRET:-$(openssl rand -base64 32)}"
```

**Verification Needed:**
- Ensure ansible playbook creates .env with JWT_SECRET
- Check that JWT_SECRET persists in .env file
- Test API restart doesn't invalidate tokens

**Status:** ‚ö†Ô∏è **VERIFY - MIGHT WORK BUT NEEDS TESTING**

---

### ISSUE #6: No Rate Limiting on Auth Endpoints üî¥

**Severity:** HIGH - **BRUTE FORCE ATTACKS POSSIBLE**

**File:** `apps/api/app/main.py:190`

**Problem:**
```python
@app.post("/api/auth/login")
def login(request: LoginRequest, db: Session = Depends(get_db)):
    # No rate limiting - unlimited login attempts
```

**Impact:**
- Attackers can brute force passwords
- Credential stuffing attacks
- Account enumeration
- DDoS via login endpoint

**Attack Scenario:**
```bash
# Attacker script:
for password in password_list.txt; do
  curl -X POST https://mail.victim.com/api/auth/login \
    -d "{\"email\":\"admin@victim.com\",\"password\":\"$password\"}"
done
# Tries 10,000 passwords in minutes
```

**Fix Required:**
```bash
# Install slowapi
pip install slowapi

# Add to requirements.txt:
slowapi==0.1.9
```

```python
# Add to main.py:
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded
from fastapi import Request

limiter = Limiter(key_func=get_remote_address)
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

@app.post("/api/auth/login")
@limiter.limit("5/minute")  # Max 5 attempts per minute per IP
async def login(
    request: Request,
    login_request: LoginRequest,
    db: Session = Depends(get_db)
):
    # ... existing code
```

**Status:** ‚ö†Ô∏è **HIGH PRIORITY - ADD BEFORE PRODUCTION**

---

## üü† HIGH PRIORITY ISSUES (Should Fix)

### ISSUE #7: Install Script References Wrong Branch üü†

**File:** `install.sh:44`

**Problem:**
```bash
REPO_BRANCH="v2-rewrite"  # ‚Üê Old branch name
```

**Current branch:** `session-6-dashboard` (based on git status)

**Impact:**
- Install script clones wrong branch
- Gets old code without dashboard and bug fixes

**Fix:**
```bash
# Update install.sh line 44:
REPO_BRANCH="main"  # or "session-6-dashboard"
```

**Status:** ‚ö†Ô∏è **FIX BEFORE MERGE TO MAIN**

---

### ISSUE #8: Dashboard Build May Fail on Low Memory Systems üü†

**Severity:** MEDIUM

**Problem:**
- Dashboard build runs `npm install` and `npm run build`
- Vite build can use 500MB-1GB RAM
- Install script warns if < 2GB RAM but continues

**Impact:**
- Build fails with "JavaScript heap out of memory"
- Deployment stops halfway through
- Requires manual cleanup and retry

**Fix:**
```yaml
# Add to ansible/roles/dashboard/tasks/main.yml before npm build:
- name: Set Node.js memory limit for build
  set_fact:
    node_max_memory: "{{ ansible_memtotal_mb | int // 2 }}"  # Use half of available RAM

- name: Build dashboard with memory limit
  shell: "NODE_OPTIONS='--max-old-space-size={{ node_max_memory }}' npm run build"
  args:
    chdir: /tmp/mailrice-dashboard
```

**Status:** ‚ö†Ô∏è **CONSIDER FOR LOW-SPEC SERVERS**

---

### ISSUE #9: No Backup Before Deployment üü†

**Severity:** MEDIUM

**Problem:**
- No backup of existing database before deployment
- No way to rollback if deployment fails
- Data loss risk on failed migrations

**Fix:**
```yaml
# Add to playbook before database migrations:
- name: Backup database before migrations
  become_user: postgres
  shell: |
    pg_dump mailrice > /var/backups/mailrice_$(date +%Y%m%d_%H%M%S).sql
  when: ansible_local.mailrice.deployed is defined
```

**Status:** ‚ö†Ô∏è **ADD FOR PRODUCTION SAFETY**

---

## üü° MEDIUM PRIORITY ISSUES (Good to Have)

### ISSUE #10: No Health Check Before Nginx Config üü°

**File:** `ansible/playbook.yml:273-280`

**Problem:**
- API starts, Ansible waits for health check
- But if health check times out, deployment continues
- Nginx config applied with broken API backend

**Fix:**
```yaml
- name: Wait for API to be ready
  uri:
    url: "http://127.0.0.1:8000/api/health"
    status_code: 200
  register: api_health
  until: api_health.status == 200
  retries: 30
  delay: 2
  failed_when: api_health.status != 200  # ‚Üê Fail deployment if API doesn't start
```

**Status:** ‚ö†Ô∏è **IMPROVE ERROR HANDLING**

---

### ISSUE #11: Missing SSL Certificate Validation üü°

**File:** `ansible/playbook.yml:140-152`

**Problem:**
- Certbot runs but failure is ignored: `failed_when: false`
- Nginx config applied even if SSL cert missing
- HTTPS won't work, connections fail

**Fix:**
```yaml
- name: Obtain SSL certificate
  command: >
    certbot certonly --dns-cloudflare ...
  register: certbot_result
  failed_when: certbot_result.rc != 0 and certbot_result.rc != 1
  # rc=1 means cert already exists (OK)
  # rc!=0,1 means real failure (FAIL)

- name: Verify SSL certificate exists
  stat:
    path: "/etc/letsencrypt/live/{{ hostname }}/fullchain.pem"
  register: ssl_cert
  failed_when: not ssl_cert.stat.exists
```

**Status:** ‚ö†Ô∏è **IMPROVE SSL VALIDATION**

---

## üü¢ LOW PRIORITY (Nice to Have)

### ISSUE #12: No Log Rotation üü¢

- `/var/log/nginx/*.log` will grow indefinitely
- Add logrotate configuration

### ISSUE #13: No Monitoring/Alerting üü¢

- No way to know if API crashes
- Consider adding basic monitoring (systemd alerts, fail2ban)

### ISSUE #14: Dashboard .env Not Validated üü¢

- Dashboard .env created with hostname but not validated
- Should verify VITE_API_BASE_URL is reachable

---

## üìä Summary

| Severity | Count | Status | Action Required |
|----------|-------|--------|-----------------|
| ‚úÖ **RESOLVED** | 1 | Done | None |
| üî¥ **CRITICAL** | 5 | **BLOCKING** | **Fix before deploy** |
| üü† **HIGH** | 3 | Warning | Fix this week |
| üü° **MEDIUM** | 2 | Advisory | Consider fixing |
| üü¢ **LOW** | 3 | Optional | Future improvement |
| **TOTAL** | **14** | - | - |

---

## ‚úÖ Pre-Deployment Checklist

### MUST FIX (Deployment Blockers):
- [x] **#1: Ansible inventory file** ‚úÖ RESOLVED
- [ ] **#2: Fix CORS configuration** (restrict to actual domain)
- [ ] **#3: Change systemd Type=notify to Type=simple**
- [ ] **#4: Commit backend bug fixes to git**
- [ ] **#5: Verify JWT_SECRET persists in .env**
- [ ] **#6: Add rate limiting to login endpoint**

### SHOULD FIX (Before Production):
- [ ] **#7: Update install.sh branch name**
- [ ] **#8: Add Node.js memory limits for build**
- [ ] **#9: Add database backup before migrations**

### NICE TO HAVE:
- [ ] #10: Improve health check error handling
- [ ] #11: Better SSL certificate validation
- [ ] #12-14: Logging, monitoring, validation

---

## üöÄ Safe Deployment Process

### 1. Fix Critical Issues (1-2 hours)

```bash
# Fix #1: ‚úÖ Already done (inventory exists)

# Fix #2: Update CORS
# Edit apps/api/app/main.py (see fix above)

# Fix #3: Update systemd service
# Edit ansible/playbook.yml line 242: Type=simple

# Fix #4: Commit changes
git add .
git commit -m "Fix 6 critical deployment issues"
git push

# Fix #6: Add slowapi to requirements.txt
echo "slowapi==0.1.9" >> apps/api/requirements.txt
```

### 2. Test Locally (if possible)

```bash
# Test dashboard build
cd apps/dashboard
npm run build

# Test backend import
cd apps/api
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python -c "from app import main; print('OK')"
```

### 3. Deploy to Staging First

```bash
# Deploy to test server first
./install.sh \
  --domain staging.example.com \
  --hostname mail-staging.example.com \
  --admin-email admin@staging.example.com
```

### 4. Verify Deployment

```bash
# Check services
systemctl status mailrice-api
systemctl status nginx
systemctl status postgresql

# Check API
curl https://mail.example.com/api/health

# Check dashboard
curl -I https://mail.example.com/

# Check logs
journalctl -u mailrice-api -n 50
tail -f /var/log/nginx/error.log
```

### 5. Production Deployment

Only after all tests pass on staging!

---

## üÜò Rollback Plan

If deployment fails:

```bash
# Stop services
systemctl stop mailrice-api nginx

# Restore database (if backup exists)
sudo -u postgres psql -c "DROP DATABASE mailrice;"
sudo -u postgres psql -c "CREATE DATABASE mailrice;"
sudo -u postgres psql mailrice < /var/backups/mailrice_TIMESTAMP.sql

# Revert code
cd /opt/mailrice
git checkout v2-rewrite  # or previous stable version

# Restart services
systemctl start mailrice-api nginx
```

---

## üìã Testing Commands

After fixing all issues, test with:

```bash
# 1. Test CORS (should be rejected)
curl https://mail.example.com/api/status \
  -H "Origin: https://evil.com" \
  -v | grep "Access-Control-Allow-Origin"
# Should NOT return evil.com

# 2. Test rate limiting
for i in {1..10}; do
  curl -X POST https://mail.example.com/api/auth/login \
    -d '{"email":"test","password":"test"}'
done
# Should get 429 after 5 attempts

# 3. Test JWT persistence
TOKEN=$(curl -X POST https://mail.example.com/api/auth/login \
  -d '{"email":"admin@example.com","password":"yourpass"}' \
  | jq -r .access_token)
# Restart API
systemctl restart mailrice-api
# Use token again - should still work
curl https://mail.example.com/api/auth/me \
  -H "Authorization: Bearer $TOKEN"

# 4. Test mailbox list performance
time curl https://mail.example.com/api/mailboxes \
  -H "Authorization: Bearer $TOKEN"
# Should be < 500ms even with many mailboxes
```

---

## üìû Support

If you encounter issues during deployment:

1. Check `/var/log/nginx/error.log`
2. Check `journalctl -u mailrice-api -n 100`
3. Check Ansible output for errors
4. Review this checklist for missed items

---

**Report Generated:** October 8, 2025
**Status:** ‚ö†Ô∏è **NOT READY FOR DEPLOYMENT**
**Action Required:** Fix 5 critical issues before deploying (1 already resolved)

**Next Steps:**
1. Fix remaining 5 critical issues (est. 1-2 hours)
2. Test on staging server
3. Deploy to production

ü§ñ **Generated with [Claude Code](https://claude.com/claude-code)**
